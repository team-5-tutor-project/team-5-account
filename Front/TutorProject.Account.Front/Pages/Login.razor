@page "/Login"
@using TutorProject.Account.Front.Dtos
@using TutorProject.Account.Front.Dtos.Token
@using TutorProject.Account.Front.Models
@inject NavigationManager NavigationManager
@inject HttpService _httpService
@inject HttpClient _http

<title>TutorService</title>
<h1>Добро пожаловать в TutorService</h1>
<h2>Войти как 
<button class="btn btn-primary" @onclick="ChangeUserType">
    @switch (UserType)
    {
        case UserType.Client:
            <a>Клиент</a>
            break;
        case UserType.Tutor:
            <a>Репетитор</a>
            break;
    }
</button>
</h2>
<p></p>
<p><input @bind="Username" placeholder="login"></p>
<p><input @bind="Password" type="password" placeholder="password"></p>
@if (LoginFailed)
{
    <p>Ошибка! Не найден пользователь с введёнными данными.</p>
}
<button class="btn btn-dark" @onclick="@OnLoginButtonClick">Войти</button>
<p></p>
<p>Ещё нет аккаунта? <a href="Registration">Регистрация</a></p>

@code {
    private UserType UserType { get; set; }
    
    private string Username { get; set; }
    private string Password { get; set; }
    
    private bool LoginFailed { get; set; }
    
    void ChangeUserType()
    {
        UserType = UserType switch {
            UserType.Client => UserType.Tutor,
            UserType.Tutor => UserType.Client,
            _ => throw new InvalidOperationException()
        };
    }

    async Task OnLoginButtonClick()
    {
        var loginRequest = new AuthorizationRequestDto
        {
            Login = Username,
            Password = Password
        };

        var loginUri = "api/authorization";
        var response = await _httpService.PostWithBody<LoginResponseDto>(loginUri, loginRequest);
        if (response.IsSuccessful)
        {
            var token = response.Result.AuthorizationToken;
            MainController.IsAuthorized = true;
            var user = await _http.GetAsync($"/api/authorization?token={token}");
            MainController.Token = token;
            var responseDto = await user.Content.ReadFromJsonAsync<TokenResponseDto>();
            MainController.User = responseDto.UserType;
            NavigationManager.NavigateTo($"/");
        }

        LoginFailed = true;
    }
}